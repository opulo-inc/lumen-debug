var w=Object.defineProperty;var v=(u,e,t)=>e in u?w(u,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):u[e]=t;var y=(u,e,t)=>(v(u,typeof e!="symbol"?e+"":e,t),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const l of s.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&i(l)}).observe(document,{childList:!0,subtree:!0});function t(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(r){if(r.ep)return;r.ep=!0;const s=t(r);fetch(r.href,s)}})();class p{constructor(){y(this,"delay",e=>new Promise(t=>setTimeout(t,e)));this.encoder=new TextEncoder,this.decoder=new TextDecoder,this.consoleDiv=document.getElementById("console"),this.port,this.receiveBuffer=[],document.getElementById("connect").addEventListener("click",()=>{this.connect()}),document.getElementById("send").addEventListener("click",()=>{this.sendRepl()}),document.getElementById("tmc").addEventListener("click",()=>{this.testTMC()}),document.getElementById("vac").addEventListener("click",()=>{this.testVac()}),document.getElementById("left-air-on").addEventListener("click",()=>{this.leftAirOn()}),document.getElementById("left-air-off").addEventListener("click",()=>{this.leftAirOff()}),document.getElementById("right-air-on").addEventListener("click",()=>{this.rightAirOn()}),document.getElementById("right-air-off").addEventListener("click",()=>{this.rightAirOff()}),document.getElementById("ring-lights-on").addEventListener("click",()=>{this.ledOn()}),document.getElementById("ring-lights-off").addEventListener("click",()=>{this.ledOff()}),document.getElementById("left-vac").addEventListener("click",()=>{this.readLeftVac()}),document.getElementById("right-vac").addEventListener("click",()=>{this.readRightVac()})}appendToConsole(e,t){let i=document.createElement("p"),r=new Date().toISOString(),s="";t?s="[SEND]":s="[RECE]",i.innerHTML=s+" - "+r+" - "+e+`
`,this.consoleDiv.appendChild(i),this.consoleDiv.scrollTop=this.consoleDiv.scrollHeight}getNextBufferLine(){return this.receiveBuffer.shift()}clearBuffer(){for(;this.receiveBuffer.length>0;)this.receiveBuffer.shift()}async connect(){if(!navigator.serial)return alert("Please use a browser that supports WebSerial (Chrome)."),!1;const e=1155;return this.port=await navigator.serial.requestPort({filters:[{usbVendorId:e}]}),console.log("Port Selected."),await this.port.open({baudRate:115200,bufferSize:255,dataBits:8,flowControl:"none",parity:"none",stopBits:1}),console.log("Port Opened."),this.listen(),document.querySelector("#connect").style.background="green",document.querySelector("#connect").style.color="white",document.querySelector("#connect").innerHTML="Connected",!0}async listen(){var e;for(;(e=this.port)!=null&&e.readable;){console.log("Port is readable: Starting to listen.");let t="";document.getElementById("console");const i=this.port.readable.getReader();try{for(;;){const{value:r,done:s}=await i.read();if(s){console.log("Closing reader.");break}const l=this.decoder.decode(r);for(t=t.concat(l);t.indexOf(`
`)!=-1;){let a=t.split(`
`);this.receiveBuffer.push(a[0]),this.appendToConsole(a[0],!1),t=t.split(`
`).slice(1).join(`
`)}}}catch(r){console.error("Reading error.",r)}finally{i.releaseLock()}}}async send(e){var t;if((t=this.port)!=null&&t.writable){const i=await this.port.writable.getWriter();for(const r of e)await i.write(this.encoder.encode(r+`
`)),this.appendToConsole(r,!0);i.releaseLock()}else alert("Cannot write to port. Have you connected?")}async sendRepl(){let e=[document.querySelector("#repl-input").value];this.send(e)}async leftAirOn(){const e=["M106","M106 P1 S255"];await this.send(e)}async leftAirOff(){const e=["M107","M107 P1"];await this.send(e)}async rightAirOn(){const e=["M106 P2 S255","M106 P3 S255"];await this.send(e)}async rightAirOff(){const e=["M107 P2","M107 P3"];await this.send(e)}async ledOn(){const e=["M150 P255 R255 U255 B255"];await this.send(e)}async ledOff(){const e=["M150 P0"];await this.send(e)}async readLeftVac(){var o;if(!((o=this.port)!=null&&o.writable))return alert("Cannot write to port. Have you connected?"),!1;const e=["M260 A112 B1 S1","M260 A109","M260 B48","M260 B10","M260 S1"],t=40;this.clearBuffer();let i,r,s;const l=new RegExp("data:(..)");await this.send(e),await this.send(["M260 A109 B6 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(t);for(var a=0,c=this.receiveBuffer.length;a<c;a++){let h=this.receiveBuffer[a];if(l.test(h)){i=h.match("data:(..)")[1];break}}this.clearBuffer(),await this.send(["M260 A109 B7 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(t);for(var a=0,c=this.receiveBuffer.length;a<c;a++){let d=this.receiveBuffer[a];if(l.test(d)){r=d.match("data:(..)")[1];break}}await this.send(["M260 A109 B8 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(t);for(var a=0,c=this.receiveBuffer.length;a<c;a++){let d=this.receiveBuffer[a];if(l.test(d)){s=d.match("data:(..)")[1];break}}let n=parseInt(i+r+s,16);alert("Left vac sensor value: "+n)}async readRightVac(){var o;if(!((o=this.port)!=null&&o.writable))return alert("Cannot write to port. Have you connected?"),!1;const e=["M260 A112 B2 S1","M260 A109","M260 B48","M260 B10","M260 S1"],t=40;let i,r,s;const l=new RegExp("data:(..)");this.clearBuffer(),await this.send(e),await this.send(["M260 A109 B6 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(t);for(var a=0,c=this.receiveBuffer.length;a<c;a++){let h=this.receiveBuffer[a];if(l.test(h)){i=h.match("data:(..)")[1];break}}this.clearBuffer(),await this.send(["M260 A109 B7 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(t);for(var a=0,c=this.receiveBuffer.length;a<c;a++){let d=this.receiveBuffer[a];if(l.test(d)){r=d.match("data:(..)")[1];break}}this.clearBuffer(),await this.send(["M260 A109 B8 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(t);for(var a=0,c=this.receiveBuffer.length;a<c;a++){let d=this.receiveBuffer[a];if(l.test(d)){s=d.match("data:(..)")[1];break}}let n=parseInt(i+r+s,16);alert("Right vacuum sensor value: "+n)}async testTMC(){let e="";const t=["M122"];await this.clearBuffer(),await this.send(t),await this.delay(5e3),console.log(this.receiveBuffer),alert("Downloading test results.");let i=new Date().toISOString();i=i+"-tmctest.txt";for(let r=0;r<this.receiveBuffer.length;r++)e=e.concat(this.receiveBuffer[r]+`
`);this.download(i,e)}async testVac(){let e="";const t=["M260 A112 B1 S1","M260 A109","M260 B48","M260 B10","M260 S1"],i=["M260 A112 B2 S1","M260 A109","M260 B48","M260 B10","M260 S1"];this.clearBuffer();let s,l,a;const c=new RegExp("data:(..)");await this.send(t),await this.send(["M260 A109 B6 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(40);for(var n=0,o=this.receiveBuffer.length;n<o;n++){let B=this.receiveBuffer[n];if(c.test(B)){s=B.match("data:(..)")[1],e=e.concat("Left MSB - "+s+`
`);break}}this.clearBuffer(),await this.send(["M260 A109 B7 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(40);for(var n=0,o=this.receiveBuffer.length;n<o;n++){let f=this.receiveBuffer[n];if(c.test(f)){l=f.match("data:(..)")[1],e=e.concat("Left CSB - "+l+`
`);break}}this.clearBuffer(),await this.send(["M260 A109 B8 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(40);for(var n=0,o=this.receiveBuffer.length;n<o;n++){let f=this.receiveBuffer[n];if(c.test(f)){a=f.match("data:(..)")[1],e=e.concat("Left LSB - "+a+`
`);break}}let h=parseInt(s+l+a,16);e=e.concat("Left Val - "+h+`
`),this.clearBuffer(),await this.send(i),await this.send(["M260 A109 B6 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(40);for(var n=0,o=this.receiveBuffer.length;n<o;n++){let f=this.receiveBuffer[n];if(c.test(f)){s=f.match("data:(..)")[1],e=e.concat("Right MSB - "+s+`
`);break}}this.clearBuffer(),await this.send(["M260 A109 B7 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(40);for(var n=0,o=this.receiveBuffer.length;n<o;n++){let f=this.receiveBuffer[n];if(c.test(f)){l=f.match("data:(..)")[1],e=e.concat("Right CSB - "+l+`
`);break}}this.clearBuffer(),await this.send(["M260 A109 B8 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(40),console.log("current buffer length: ",this.receiveBuffer.length);for(var n=0,o=this.receiveBuffer.length;n<o;n++){let f=this.receiveBuffer[n];if(c.test(f)){a=f.match("data:(..)")[1],e=e.concat("Right LSB - "+a+`
`);break}}let m=parseInt(s+l+a,16);e=e.concat("Right Val - "+m+`
`),console.log(h,m),alert("Downloading test result. Left Sensor: "+h+", Right Sensor: "+m);let d=new Date().toISOString();d=d+"-vactest.txt",this.download(d,e)}download(e,t){var i=document.createElement("a");i.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(t)),i.setAttribute("download",e),i.style.display="none",document.body.appendChild(i),i.click(),document.body.removeChild(i)}}new p;
