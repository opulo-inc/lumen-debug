var S=Object.defineProperty;var x=(f,e,t)=>e in f?S(f,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):f[e]=t;var w=(f,e,t)=>(x(f,typeof e!="symbol"?e+"":e,t),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))a(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const l of i.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&a(l)}).observe(document,{childList:!0,subtree:!0});function t(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function a(n){if(n.ep)return;n.ep=!0;const i=t(n);fetch(n.href,i)}})();class A{constructor(){w(this,"delay",e=>new Promise(t=>setTimeout(t,e)));this.encoder=new TextEncoder,this.decoder=new TextDecoder,this.consoleDiv=document.getElementById("console"),this.port,this.receiveBuffer=[],this.sentCommandBuffer=[""],this.sentCommandBufferIndex=0}appendToConsole(e,t){let a=document.createElement("p"),n=new Date().toISOString(),i="";t?i="[SEND]":i="[RECE]",a.innerHTML=i+" - "+n+" - "+e+`
`,this.consoleDiv.appendChild(a),this.consoleDiv.scrollTop=this.consoleDiv.scrollHeight}getNextBufferLine(){return this.receiveBuffer.shift()}clearBuffer(){for(;this.receiveBuffer.length>0;)this.receiveBuffer.shift()}async connect(){if(!navigator.serial)return alert("Please use a browser that supports WebSerial (Chrome)."),!1;const e=1155;return this.port=await navigator.serial.requestPort({filters:[{usbVendorId:e}]}),console.log("Port Selected."),await this.port.open({baudRate:115200,bufferSize:255,dataBits:8,flowControl:"none",parity:"none",stopBits:1}),console.log("Port Opened."),this.listen(),document.querySelector("#connect").style.background="green",document.querySelector("#connect").style.color="white",document.querySelector("#connect").innerHTML="Connected",!0}async listen(){var e;for(;(e=this.port)!=null&&e.readable;){console.log("Port is readable: Starting to listen.");let t="";document.getElementById("console");const a=this.port.readable.getReader();try{for(;;){const{value:n,done:i}=await a.read();if(i){console.log("Closing reader.");break}const l=this.decoder.decode(n);for(t=t.concat(l);t.indexOf(`
`)!=-1;){let r=t.split(`
`);this.receiveBuffer.push(r[0]),this.appendToConsole(r[0],!1),t=t.split(`
`).slice(1).join(`
`)}}}catch(n){console.error("Reading error.",n)}finally{a.releaseLock()}}}async send(e){var t;if(console.log("sending: ",e),(t=this.port)!=null&&t.writable){const a=await this.port.writable.getWriter();for(const n of e)await a.write(this.encoder.encode(n+`
`)),this.appendToConsole(n,!0);a.releaseLock()}else alert("Cannot write to port. Have you connected?")}async sendRepl(){let e=[document.querySelector("#repl-input").value];this.sentCommandBuffer.splice(1,0,e[0]),this.sentCommandBufferIndex=0,this.send(e)}async leftAirOn(){const e=["M106","M106 P1 S255"];await this.send(e)}async leftAirOff(){const e=["M107","M107 P1"];await this.send(e)}async rightAirOn(){const e=["M106 P2 S255","M106 P3 S255"];await this.send(e)}async rightAirOff(){const e=["M107 P2","M107 P3"];await this.send(e)}async ledOn(){const e=["M150 P255 R255 U255 B255"];await this.send(e)}async ledOff(){const e=["M150 P0"];await this.send(e)}async readLeftVac(){var u;if(!((u=this.port)!=null&&u.writable))return alert("Cannot write to port. Have you connected?"),!1;const e=["M260 A112 B1 S1","M260 A109","M260 B48","M260 B10","M260 S1"],t=40;this.clearBuffer();let a,n,i;const l=new RegExp("data:(..)");await this.send(e),await this.send(["M260 A109 B6 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(t);for(var r=0,o=this.receiveBuffer.length;r<o;r++){let m=this.receiveBuffer[r];if(l.test(m)){a=m.match("data:(..)")[1];break}}this.clearBuffer(),await this.send(["M260 A109 B7 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(t);for(var r=0,o=this.receiveBuffer.length;r<o;r++){let c=this.receiveBuffer[r];if(l.test(c)){n=c.match("data:(..)")[1];break}}await this.send(["M260 A109 B8 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(t);for(var r=0,o=this.receiveBuffer.length;r<o;r++){let c=this.receiveBuffer[r];if(l.test(c)){i=c.match("data:(..)")[1];break}}let s=parseInt(a+n+i,16);alert("Left vac sensor value: "+s)}async readRightVac(){var u;if(!((u=this.port)!=null&&u.writable))return alert("Cannot write to port. Have you connected?"),!1;const e=["M260 A112 B2 S1","M260 A109","M260 B48","M260 B10","M260 S1"],t=40;let a,n,i;const l=new RegExp("data:(..)");this.clearBuffer(),await this.send(e),await this.send(["M260 A109 B6 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(t);for(var r=0,o=this.receiveBuffer.length;r<o;r++){let m=this.receiveBuffer[r];if(l.test(m)){a=m.match("data:(..)")[1];break}}this.clearBuffer(),await this.send(["M260 A109 B7 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(t);for(var r=0,o=this.receiveBuffer.length;r<o;r++){let c=this.receiveBuffer[r];if(l.test(c)){n=c.match("data:(..)")[1];break}}this.clearBuffer(),await this.send(["M260 A109 B8 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(t);for(var r=0,o=this.receiveBuffer.length;r<o;r++){let c=this.receiveBuffer[r];if(l.test(c)){i=c.match("data:(..)")[1];break}}let s=parseInt(a+n+i,16);alert("Right vacuum sensor value: "+s)}async testTMC(){var n;if(!((n=this.port)!=null&&n.writable))return alert("Cannot write to port. Have you connected?"),!1;let e="";const t=["M122"];await this.clearBuffer(),await this.send(t),await this.delay(5e3),console.log(this.receiveBuffer);for(let i=0;i<this.receiveBuffer.length;i++)e=e.concat(this.receiveBuffer[i]+`
`);alert("Downloading test results.");let a=new Date().toISOString();a=a+"-tmctest.txt",this.download(a,e)}async testVac(){var p;if(!((p=this.port)!=null&&p.writable))return alert("Cannot write to port. Have you connected?"),!1;let e="";const t=["M260 A112 B1 S1","M260 A109","M260 B48","M260 B10","M260 S1"],a=["M260 A112 B2 S1","M260 A109","M260 B48","M260 B10","M260 S1"],n=100;this.clearBuffer();let i,l,r;const o=new RegExp("data:(..)");await this.send(t),await this.send(["M260 A109 B6 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(n);for(var s=0,u=this.receiveBuffer.length;s<u;s++){let E=this.receiveBuffer[s];if(o.test(E)){i=E.match("data:(..)")[1],e=e.concat("Left MSB - "+i+`
`);break}}this.clearBuffer(),await this.send(["M260 A109 B7 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(n);for(var s=0,u=this.receiveBuffer.length;s<u;s++){let y=this.receiveBuffer[s];if(o.test(y)){l=y.match("data:(..)")[1],e=e.concat("Left CSB - "+l+`
`);break}}this.clearBuffer(),await this.send(["M260 A109 B8 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(n);for(var s=0,u=this.receiveBuffer.length;s<u;s++){let y=this.receiveBuffer[s];if(o.test(y)){r=y.match("data:(..)")[1],e=e.concat("Left LSB - "+r+`
`);break}}let m=parseInt(i+l+r,16);e=e.concat("Left Val - "+m+`
`),this.clearBuffer(),await this.send(a),await this.send(["M260 A109 B6 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(n);for(var s=0,u=this.receiveBuffer.length;s<u;s++){let y=this.receiveBuffer[s];if(o.test(y)){i=y.match("data:(..)")[1],e=e.concat("Right MSB - "+i+`
`);break}}this.clearBuffer(),await this.send(["M260 A109 B7 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(n);for(var s=0,u=this.receiveBuffer.length;s<u;s++){let y=this.receiveBuffer[s];if(o.test(y)){l=y.match("data:(..)")[1],e=e.concat("Right CSB - "+l+`
`);break}}this.clearBuffer(),await this.send(["M260 A109 B8 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(n),console.log("current buffer length: ",this.receiveBuffer.length);for(var s=0,u=this.receiveBuffer.length;s<u;s++){let y=this.receiveBuffer[s];if(o.test(y)){r=y.match("data:(..)")[1],e=e.concat("Right LSB - "+r+`
`);break}}let g=parseInt(i+l+r,16);e=e.concat("Right Val - "+g+`
`),console.log(m,g),alert("Downloading test result. Left Sensor: "+m+", Right Sensor: "+g);let c=new Date().toISOString();c=c+"-vactest.txt",this.download(c,e)}download(e,t){var a=document.createElement("a");a.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(t)),a.setAttribute("download",e),a.style.display="none",document.body.appendChild(a),a.click(),document.body.removeChild(a)}}let h={GET_ID:[1,"UNICAST",1],INITIALIZE:[2,"UNICAST",13],GET_VERSION:[3,"UNICAST",1],MOVE_FEED_FORWARD:[4,"UNICAST",2],MOVE_FEED_BACKWARD:[5,"UNICAST",2],MOVE_FEED_STATUS:[6,"UNICAST",1],VENDOR_OPTIONS:[191,"UNICAST",0],GET_FEEDER_ADDRESS:[192,"BROADCAST",13],IDENTIFY_FEEDER:[193,"BROADCAST",13],PROGRAM_FEEDER_FLOOR:[194,"BROADCAST",14],UNINITIALIZED_FEEDERS_RESPOND:[195,"BROADCAST",1]};const k="/assets/feeder-icon-oeVaefd-.png";class T{constructor(e){this.serial=e,this.packetID=0,this.feeders=[]}beautifyResponse(e){let t="",a=e.slice(6);for(let n=0;n<a.length;n++)t=t+this.intToHexString(a[n])+" ";alert("From: "+this.intToHexString(e[1])+`
PacketID: `+this.intToHexString(e[2])+`
Payload Length: `+this.intToHexString(e[3])+`
Checksum: `+this.intToHexString(e[4])+`
Status: `+this.intToHexString(e[5])+`
Payload: `+t)}intToHexString(e){let t=e.toString(16).toUpperCase();return t.length==1&&(t="0".concat(t)),"0x".concat(t)}calcCRC(e){let t=0;for(var a=0;a<e.length;a++){t=t^e[a]<<8;for(let n=0;n<8;n++)t&32768&&(t=t^33664),t<<=1}return t>>8&255}hexStringToIntArray(e){let t=[];console.log("string: ",e);for(let a=0;a<e.length/2;a++){let n=a*2,i=e.slice(n,n+2),l=parseInt(i,16);t[a]=l}return t}validatePacketCrc(e){let t=e[4],a=e.slice(0,4).concat(e.slice(5)),n=this.calcCRC(a);return t!=n?(console.log("Received packet had CRC mismatch."),!1):!0}intArrayToHexString(e){let t="";for(let a=0;a<e.length;a++){let n=e[a].toString(16).toUpperCase();n.length==1&&(n="0".concat(n)),t=t.concat(n)}return t}getGcodeFromPacketAndPayloadArray(e){let t=e,a=this.calcCRC(e);t.splice(4,0,a),console.log("finalArray: ",t);let n=this.intArrayToHexString(t);return"M485 ".concat(n)}async sendPacket(e,t,a){if(e[1]=="UNICAST"&&t=="")return console.log("Error: Selected command requires address."),!1;if(e[2]>1&&a===void 0)return console.log("Error: Selected command requires payload."),!1;let n;e[2]==0?(console.log("first one"),console.log(a.length),n=[t,0,this.packetID,a.length+1]):n=[t,0,this.packetID,e[2]],console.log(n," header");let i=n.concat([e[0]]);(e[2]>1||e[2]==0)&&(i=i.concat(a));let l=this.getGcodeFromPacketAndPayloadArray(i);this.serial.clearBuffer(),await this.serial.send([l]);let r=Date.now();for(;;){if(await this.serial.delay(10),Date.now()-r>400)return console.log("Timeout: didn't get serial response."),!1;let g=!1;console.log(this.serial.receiveBuffer);const c=new RegExp("ok");for(let p=0,E=this.serial.receiveBuffer.length;p<E;p++){let I=this.serial.receiveBuffer[p];if(g=c.test(I),g)break}if(g)break}let o=this.packetID;this.packetID<255?this.packetID++:this.packetID=0;let s="";const u=new RegExp("rs485-reply:");for(let g=0,c=this.serial.receiveBuffer.length;g<c;g++){let p=this.serial.receiveBuffer[g];if(u.test(p)){s=p.match("rs485-reply: (.*)")[1];break}}if(s=="TIMEOUT")return console.log("Received TIMEOUT."),!1;if(s=="")return alert("Your version of Marlin does not support Photon. Please update Marlin to the version in the latest LumenPnP release."),!1;let m=this.hexStringToIntArray(s);return this.validatePacketCrc(m)?m[2]!=o?(console.log("Returning packet ID mismatched sent packet ID."),!1):m:!1}async sendUnicast(){let e=document.getElementById("uni-to").value,t=document.getElementById("uni-command").value,a=document.getElementById("uni-payload").value;e=parseInt(e),a=this.hexStringToIntArray(a);let n;t==1?n=await this.sendPacket(h.GET_ID,e):t==2?n=await this.sendPacket(h.INITIALIZE,e,a):t==3?n=await this.sendPacket(h.GET_VERSION,e):t==4?n=await this.sendPacket(h.MOVE_FEED_FORWARD,e,a):t==5?n=await this.sendPacket(h.MOVE_FEED_BACKWARD,e,a):t==6?n=await this.sendPacket(h.MOVE_FEED_STATUS,e):t==191&&(console.log(a),n=await this.sendPacket(h.VENDOR_OPTIONS,e,a)),n!=!1?this.beautifyResponse(n):alert("We did not receive a valid packet.")}async sendBroadcast(){let e=document.getElementById("broad-program-address").value,t=document.getElementById("broad-command").value,a=document.getElementById("broad-uuid").value;e=parseInt(e),a=this.hexStringToIntArray(a);let n;t==192?n=await this.sendPacket(h.GET_FEEDER_ADDRESS,255,a):t==193?n=await this.sendPacket(h.IDENTIFY_FEEDER,255,a):t==194?(a.push(e),n=await this.sendPacket(h.PROGRAM_FEEDER_FLOOR,255,a)):t==195&&(n=await this.sendPacket(h.UNINITIALIZED_FEEDERS_RESPOND,255)),n!=!1?this.beautifyResponse(n):alert("We did not receive a valid packet.")}async customPacket(){let e=parseInt(document.getElementById("custom-to").value),t=parseInt(document.getElementById("calc-command").value),a=parseInt(document.getElementById("calc-payload").value);if(e===NaN||t===NaN)return alert("Please make sure you've entered at least a To Address and a Command"),!1;let n;a==""?n=await this.sendPacket(t,e):n=await this.sendPacket(t,e,a),n!=!1?this.beautifyResponse(n):alert("We did not receive a valid packet.")}async calculateUserCRC(){let e=parseInt(document.getElementById("calc-to").value),t=parseInt(document.getElementById("calc-from").value),a=parseInt(document.getElementById("calc-packetid").value),n=parseInt(document.getElementById("calc-payload-length").value),i=parseInt(document.getElementById("calc-command").value),l=this.hexStringToIntArray(document.getElementById("calc-payload").value),r=[e,t,a,n,i];r=r.concat(l);let o=this.calcCRC(r);alert(o)}async scan(){let e=50;for(let t=1;t<e+1;t++){let a=await this.sendPacket(h.GET_ID,t);if(a!=!1&&a[5]==0){let n=a.slice(6);if((await this.sendPacket(h.INITIALIZE,t,n))[5]==0){console.log("found one at ",t),n=this.intArrayToHexString(n);let l=t.toString(),r=document.createElement("div"),o=document.createElement("img");o.src=k;let s=document.createElement("H3"),u=document.createTextNode(l);s.appendChild(u);let m=document.createElement("H4"),g=document.createTextNode(n);m.appendChild(g);let c=document.createElement("button"),p=document.createTextNode("Identify");c.appendChild(p),c.classList.add("identify");let E=document.createElement("button"),I=document.createTextNode("Feed");E.appendChild(I),E.classList.add("feed"),r.appendChild(o),r.appendChild(s),r.appendChild(m),r.appendChild(c),r.appendChild(E),r.classList.add("found-feeder"),document.getElementById("found-feeders").appendChild(r)}}}document.getElementById("feeder-scan").innerHTML="Scan"}async programSlotsUtility(){alert("To program your slots, first remove all Photon feeders from your machine. Once you've done this, click ok.");for(let e=1;e<51;e++){alert("Insert a feeder into slot "+e+". Once you've done this, click ok.");let t=await this.sendPacket(h.UNINITIALIZED_FEEDERS_RESPOND,255);if(t==!1)return alert("Programming feeder not found. Exiting."),!1;{await this.sendPacket(h.PROGRAM_FEEDER_FLOOR,255,t.slice(6).concat(e));let a=await this.sendPacket(h.GET_FEEDER_ADDRESS,255,t.slice(6));if(a!=!1&&a[1]==e){if(!confirm("Slot has been programmed with address "+e+"! Remove the feeder from the slot, then click ok to move to the next address. Click cancel to stop."))return!1}else if(!confirm("Programming Failed for slot "+e+". Would you like to continue?"))return!1}}}}let d=new A,B=new T(d);function R(){document.getElementById("repl-input").value=""}document.getElementById("repl-input").addEventListener("keyup",function(f){if(f.code==="Enter")f.preventDefault(),document.getElementById("send").click();else if(f.code==="ArrowUp"){if(f.preventDefault(),d.sentCommandBufferIndex==d.sentCommandBuffer.length-1)return!1;d.sentCommandBufferIndex++,document.getElementById("repl-input").value=d.sentCommandBuffer[d.sentCommandBufferIndex]}else if(f.code==="ArrowDown"){if(f.preventDefault(),d.sentCommandBufferIndex==0)return!1;d.sentCommandBufferIndex--,document.getElementById("repl-input").value=d.sentCommandBuffer[d.sentCommandBufferIndex]}});document.getElementById("uni-command").addEventListener("change",()=>{let f=document.getElementById("uni-command").value;["0x01","0x03","0x06"].includes(f)?(document.getElementById("uni-payload").style.display="none",document.getElementById("uni-payload-label").style.display="none"):(document.getElementById("uni-payload").style.display="inline",document.getElementById("uni-payload-label").style.display="inline")});document.getElementById("connect").addEventListener("click",()=>{d.connect()});document.getElementById("send").addEventListener("click",()=>{d.sendRepl(),R()});document.getElementById("tmc").addEventListener("click",()=>{d.testTMC()});document.getElementById("vac").addEventListener("click",()=>{d.testVac()});document.getElementById("left-air-on").addEventListener("click",()=>{d.leftAirOn()});document.getElementById("left-air-off").addEventListener("click",()=>{d.leftAirOff()});document.getElementById("right-air-on").addEventListener("click",()=>{d.rightAirOn()});document.getElementById("right-air-off").addEventListener("click",()=>{d.rightAirOff()});document.getElementById("ring-lights-on").addEventListener("click",()=>{d.ledOn()});document.getElementById("ring-lights-off").addEventListener("click",()=>{d.ledOff()});document.getElementById("left-vac").addEventListener("click",()=>{d.readLeftVac()});document.getElementById("right-vac").addEventListener("click",()=>{d.readRightVac()});document.getElementById("feeder-scan").addEventListener("click",()=>{var f;if(!((f=d.port)!=null&&f.writable))return alert("Cannot write to port. Have you connected?"),!1;document.getElementById("found-feeders").style.display="flex",document.getElementById("found-feeders").innerHTML="",document.getElementById("feeder-scan").innerHTML="Scanning...",B.scan()});document.getElementById("uni-send").addEventListener("click",()=>{B.sendUnicast()});document.getElementById("broad-send").addEventListener("click",()=>{B.sendBroadcast()});document.getElementById("calc-calculate").addEventListener("click",()=>{B.calculateUserCRC()});document.getElementById("program-slots").addEventListener("click",()=>{B.programSlotsUtility()});document.getElementById("more-controls").addEventListener("click",()=>{document.getElementById("unicast").style.display="block",document.getElementById("broadcast").style.display="block",document.getElementById("custom-packet").style.display="block",document.getElementById("crc-tool").style.display="block"});document.getElementById("found-feeders").addEventListener("click",function(f){let e=f.target;if(e.className.split(" ").includes("identify")&&e.nodeName=="BUTTON"){let a=e.parentElement.getElementsByTagName("H4")[0].innerHTML;a=B.hexStringToIntArray(a),B.sendPacket(h.IDENTIFY_FEEDER,255,a)}else if(e.className.split(" ").includes("feed")&&e.nodeName=="BUTTON"){let a=e.parentElement.getElementsByTagName("H3")[0].innerHTML;a=parseInt(a),B.sendPacket(h.MOVE_FEED_FORWARD,a,40)}});
